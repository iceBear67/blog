<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>从零开始的编译器生涯 - nstd::out</title><link rel="manifest" href="../../../../manifest.json"><meta name="application-name" content="Nstd::Out"><meta name="msapplication-TileImage" content="/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Nstd::Out"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="近日一屑高二学生无聊动手写起了编译器….这是他的珍贵作战记录"><meta property="og:type" content="blog"><meta property="og:title" content="从零开始的编译器生涯"><meta property="og:url" content="https://nstd.sfclub.cc/2021/10/01/Writting-A-Compiler-1/"><meta property="og:site_name" content="nstd::out"><meta property="og:description" content="近日一屑高二学生无聊动手写起了编译器….这是他的珍贵作战记录"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://nstd.sfclub.cc/cover-compiler.png"><meta property="article:published_time" content="2021-10-01T14:12:37.000Z"><meta property="article:modified_time" content="2021-10-01T15:39:30.355Z"><meta property="article:author" content="iceBear67"><meta property="article:tag" content="tech"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="../../../../cover-compiler.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://nstd.sfclub.cc/2021/10/01/Writting-A-Compiler-1/"},"headline":"nstd::out","image":["https://nstd.sfclub.cc/cover-compiler.png"],"datePublished":"2021-10-01T14:12:37.000Z","dateModified":"2021-10-01T15:39:30.355Z","author":{"@type":"Person","name":"iceBear67"},"description":"近日一屑高二学生无聊动手写起了编译器….这是他的珍贵作战记录"}</script><link rel="canonical" href="https://nstd.sfclub.cc/2021/10/01/Writting-A-Compiler-1/"><link rel="alternate" href="../../../../atom.xml" title="nstd::out" type="application/atom+xml"><link rel="icon" href="../../../../favicon.ico"><link rel="stylesheet" href="jsdelivr"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/rainbow.css"><link rel="stylesheet" href="jsdelivr"><link rel="stylesheet" href="../../../../css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="../../../../index.html"><img src="../../../../sitelogo.png" alt="nstd::out" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="../../../../index.html">主页</a><a class="navbar-item" href="../../../../archives">归档</a><a class="navbar-item" href="../../../../categories">分类</a><a class="navbar-item" href="../../../../links">友链</a><a class="navbar-item" href="../../../../%E7%A9%BA%E8%B0%83%E6%88%BF">空调房</a><a class="navbar-item" href="../../../../about">关于</a></div><div class="navbar-end"><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="../../../../cover-compiler.png" alt="从零开始的编译器生涯"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-10-01T14:12:37.000Z" title="01/10/2021, 22:12:37">2021-10-01</time>发表</span><span class="level-item"><time dateTime="2021-10-01T15:39:30.355Z" title="01/10/2021, 23:39:30">2021-10-01</time>更新</span><span class="level-item">16 分钟读完 (大约2335个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">从零开始的编译器生涯</h1><div class="content"><p>近日一屑高二学生无聊动手写起了编译器….这是他的珍贵作战记录    </p>
<span id="more"></span>

<h1 id="0x01-理论基础"><a href="#0x01-理论基础" class="headerlink" title="0x01 理论基础"></a>0x01 理论基础</h1><p>我摊牌，我没有看任何编译原理相关的书籍，因此这篇文章并不能作为严格的参考资料，甚至很多地方可能是错误的。  </p>
<p>编译器，编译器，就是把高级语言的代码编译成另一种形式（class，asm，二进制，IR），而他在编译成另一种形式之前大概需要过这么个流程:</p>
<p>Lex -&gt; Parse -&gt; Compile  </p>
<p>接下来逐步讲解这个过程。</p>
<h2 id="Lexer"><a href="#Lexer" class="headerlink" title="Lexer"></a>Lexer</h2><p>就是分词器，输入用户提供的代码接着把他分成 <code>tokens</code>，也就是 <code>tokenstream</code>。<br>你肯定看不懂上面那句话的意思，让我们来点实例：<br><img src="https://upload.cc/i1/2021/10/01/gGftuh.png" alt="image"><br><code>a.value</code> 里的那个 <code>ArrayList</code> 就是一个 <code>token stream</code>，<code>str</code> 是被解析的代码。不难发现，语句被 Lexer 按顺序进行了分类以及数据的分割，如 <code>a</code> 被识别为了一个 <code>Identify</code> (标记)。 </p>
<p>因此也可以归纳出来 <code>Token</code> 大致的代码长啥样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Token</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> line;</span><br><span class="line">    <span class="keyword">private</span> Type type;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a>Parser</h2><p>Lexer 从源码中提取出 <code>token stream</code> 后将会交给 <code>Parser</code> 处理，它负责对 <code>token stream</code> 进行解析，生成一个 <code>AST (Abstract Syntax Tree)</code>，也就是 <code>抽象语法树</code>。  </p>
<p><img src="https://upload.cc/i1/2021/10/01/nVE3wl.png"><br>这张图直观的描述了这一过程，你可以看到它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。之所以说语法是“抽象”的，是因为这里的语法并不会表示出真实语法中出现的每个细节。  </p>
<p>接着，AST 将会丢给代码生成器用于生成代码，但是一般会先对 AST 进行优化，例如 <code>常量折叠</code></p>
<h2 id="Static-Analyzing"><a href="#Static-Analyzing" class="headerlink" title="Static Analyzing"></a>Static Analyzing</h2><p>但在这之前，我们还有一些问题要解决。<br><del>其实这玩意我是和 Parser 写一块的</del><br>试想一下，如果有这样一行代码：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i = love + cats</span><br></pre></td></tr></table></figure>
<p>代码生成器如何知道 <code>love</code> 和 <code>cats</code> 是什么？ 在 Parser 的眼里，他们只是 <code>Identifier</code>，然而它们之间不能相加减。  </p>
<p>在这种时候，Parser 需要预先建立一个符号表，这样他才能找出 <code>love</code> 和 <code>cats</code> 究竟是什么以及是否能够编译。</p>
<p>同理，下面的代码也一样需要这一过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(List&lt;String&gt; args)</span></span>&#123; <span class="comment">// 此处 Parser 将会分析出 java.lang.String 和 java.util.List</span></span><br><span class="line">  NullCat nc = <span class="keyword">new</span> SBNC(); <span class="comment">// 按照 Java 的逻辑，此处没有导入（或同包）于是会产生错误，因为Parser找不到 SBNC / NullCat</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Code-Generation"><a href="#Code-Generation" class="headerlink" title="Code Generation"></a>Code Generation</h2><p>接着是生成代码！<br>一般编译器都会输出一种 <code>IR (Intermediate Representation)</code> 码，而他的作用则是一种中间表示。<br>例如，如果你输出 LLVM 的 IR 码，那么接下来你的编译工作（win,x64,linux,…jvm）就可以交给 LLVM 来完成，而像 <code>LLVM</code> 这样负责最后这一步骤的我们称之为 <code>编译器的后端</code></p>
<p>使用这一种方法有几个好处：</p>
<ul>
<li>它可以使得开发者更专注于 <code>语言设计</code> 而不用过多的考虑 <code>优化</code>，因为大多数编译器后端会帮你完成这件事情 <del>，除非你直接输出汇编那就得你自己负责优化了</del>。</li>
<li>IR 是中间表示，它可以按照相同的语义编译出不同平台，不同架构的代码，大大节省了开发者时间</li>
<li>…</li>
</ul>
<p> 处于个人习惯，我选择了 Java 的字节码作为 “IR”，他将会被 JVM 加载并在运行过程中收集数据被更好的优化以及可以享受和 Java 互操作，跨平台的优势。</p>
<h1 id="0x02-实践"><a href="#0x02-实践" class="headerlink" title="0x02 实践"></a>0x02 实践</h1><p>知道了这些理论，我们立即可以开始编写我们的第一个 Lexer 了。</p>
<p>这是我们这一大章节的目标代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">using java.util.List</span><br><span class="line"></span><br><span class="line">fn main(args: List&lt;String&gt;)&#123;</span><br><span class="line">  println &quot;hello world!&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么，让我们开始吧！<br>下文将会有大量代码，为了可读性，我会删掉一些无关紧要的部分。</p>
<h2 id="Lexer-1"><a href="#Lexer-1" class="headerlink" title="Lexer"></a>Lexer</h2><p>我的 Lexer 分为两步：<code>fuzzyTokenize</code> 和 <code>tokenize</code>。<br>实际上这是取决于做法的，有正则转 DFA（状态机）的，也有直接 <code>charStream</code> 的。</p>
<p>我选择了第二种，因为我认为使用正则的代码可读性比较糟糕，不易于维护。那么，让我们开始做一些准备工作…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lexer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String fileName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String rawContent;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Lexer</span><span class="params">(String content,String fileName)</span> </span>&#123;</span><br><span class="line">        rawContent = content.replaceAll(<span class="string">&quot;//.*|(\&quot;(?:\\\\[^\&quot;]|\\\\\&quot;|.)*?\&quot;)|(?s)/\\*.*?\\*/&quot;</span>, <span class="string">&quot;$1 &quot;</span>); <span class="comment">// remove comments.</span></span><br><span class="line">        <span class="keyword">this</span>.fileName=fileName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从构造方法接受源代码和文件名并且删除注释。你可能会问文件名用来干啥，那当然是用来报错的～<br>接着，还有一个 <code>LexedNode</code> 用来表示 <code>fuzzyTokenize</code> 后的产物。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LexedNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> NodeType type;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化和getter...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">NodeType</span> </span>&#123;</span><br><span class="line">        IDENTIFIER,SYMBOL,KEYWORD,OPERATOR,</span><br><span class="line">        LINE_SEPERATOR,</span><br><span class="line">        LITERAL_STRING,LITERAL_NUMBER</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这就是一个最基本的 <code>token</code>! 在后文，我们将会进行第二次 <code>tokenize</code> 使它变得更详细。  </p>
<p>准备好了，开始写吧！首先是一个状态机：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;LexedNode&gt; <span class="title">fuzzyTokenize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>[] charStream = rawContent.toCharArray();</span><br><span class="line">    List&lt;LexedNode&gt; nodes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">int</span> line = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; charStream.length; i++) &#123; <span class="comment">// 使用 fori 是为了循环时移动指针</span></span><br><span class="line">        <span class="keyword">char</span> now = charStream[i];</span><br><span class="line">        <span class="keyword">switch</span> (now) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;\n&#x27;</span>:</span><br><span class="line">              nodes.add(<span class="keyword">new</span> LexedNode(NodeType.LINE_SEPERATOR,<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">              <span class="keyword">continue</span>; <span class="comment">// 此处使用 continue 立即跳到下一次循环</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nodes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就是你的第一个 Lexer，可以先输出一下看看结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LINE_SEPERATOR</span><br><span class="line"></span><br><span class="line">LINE_SEPERATOR</span><br><span class="line"></span><br><span class="line">LINE_SEPERATOR</span><br><span class="line"></span><br><span class="line">LINE_SEPERATOR</span><br><span class="line"></span><br><span class="line">LINE_SEPERATOR</span><br></pre></td></tr></table></figure>

<p>因为代码有五行，因此是五个 <code>LINE_SEPERATOR</code>。<br>只有换行符可不够，我们还要识别 <code>KEYWORD</code> ，也就是关键词。<br>然而关键词使用空格分割，因此我们可以这样做：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(...)&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27; &#x27;</span>:                </span><br><span class="line">        inIdOrLiteral = !inIdOrLiteral;</span><br><span class="line">        <span class="keyword">if</span> (inIdOrLiteral) &#123; <span class="comment">// start collecting</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// end!</span></span><br><span class="line">        String str = buffer.toString();</span><br><span class="line">        identifierParse(str, nodes);</span><br><span class="line">        buffer = <span class="keyword">new</span> StringBuilder(); <span class="comment">// compose</span></span><br><span class="line">         <span class="keyword">continue</span>;</span><br><span class="line">    <span class="comment">// 此处换行同理</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Collect String or Identifier */</span></span><br><span class="line">    <span class="keyword">if</span> (inIdOrLiteral) &#123;</span><br><span class="line">        buffer.append(now);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>你可以看到，我们引入了两个新的变量和一个方法，它们分别是 <code>inIdOrLiteral</code> 和 <code>buffer</code> 以及 <code>identifierParse</code>。</p>
<p><strong>inIdOrLiteral</strong> 表示当前是否正在遍历一个 <code>Identifier</code> 或者一个字面量<br><strong>buffer</strong> 用于收集这个字面量，当然你也可以使用 <code>substring</code> 和 <code>charAt</code> 的方法<br><strong>identifierParse</strong> 是一个方法，他用于分类 Identifier。对于 <code>11</code>，他会分类成一个 <code>LITERAL_NUMBER</code>，对于 <code>not_a_keyword</code>，他会分类成一个 identifier，对于 <code>fn</code>，他会分类成一个 Keyword。</p>
<p>还没完，天资聪颖的你肯定已经注意到了这里少了一样东西——我要怎么匹配最开头的一个 <code>using</code> ？ <code>using</code> 的前头可没有一个空格。<br>这时你可以回忆一下，在各种编程语言中作为 <code>Identifier</code> 的符号应该符合什么规则….是的，他们通常不会以运算符作为开头，以及他们不是一个关键字，因此我们还可以利用这个特性写出这样的代码:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">         <span class="comment">/* Other Symbols */</span></span><br><span class="line">         <span class="keyword">if</span> (SYMBOL_OR_OPERATORS.contains(now）) &#123;</span><br><span class="line">             <span class="keyword">if</span> (inIdOrLiteral) &#123; <span class="comment">// keyword</span></span><br><span class="line">                 <span class="comment">// now == a symbol,we should end this.</span></span><br><span class="line">                 identifierParse(buffer.toString(), nodes);</span><br><span class="line">                 buffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                 inIdOrLiteral = <span class="keyword">false</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">if</span> (SYMBOLS.contains(now)) &#123;</span><br><span class="line">                 nodes.add(<span class="keyword">new</span> LexedNode(now, LexedNode.NodeType.SYMBOL));</span><br><span class="line">                 <span class="keyword">continue</span>;</span><br><span class="line">             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (OPERATORS.contains(now)) &#123;</span><br><span class="line">                 nodes.add(<span class="keyword">new</span> LexedNode(now, LexedNode.NodeType.OPERATOR));</span><br><span class="line">                 <span class="keyword">continue</span>;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="keyword">throw</span> <span class="keyword">new</span> LexerException(fileName+<span class="string">&quot;: Unknown char: &quot;</span> + now+<span class="string">&quot; line: &quot;</span>+line);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             inIdOrLiteral = <span class="keyword">true</span>; <span class="comment">// not symbol &amp; not identifier</span></span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Collect String or Identifier */</span></span><br><span class="line"> <span class="keyword">if</span> (inIdOrLiteral) &#123;</span><br><span class="line">     buffer.append(now);</span><br><span class="line">     <span class="keyword">continue</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>这一段代码将会在匹配第一个字符没有遇到语言规定的操作符或者特殊符号的时候把 <code>inIdOrLiteral</code> 设置为 <code>true</code>。配合上面的代码，在遇到一个空格的时候他会结束收集并且尝试判断是什么。</p>
<p>实际上应该是 <code>switch</code> 的任务但是写成 <code>if</code> 更加直观一些。  </p>
<p>那么到现在，我们可以开始尝试代码了！这是 Lexer 的输出：</p>
<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">KEYWORD using</span><br><span class="line">IDENTIFIER java</span><br><span class="line">OPERATOR .</span><br><span class="line">IDENTIFIER util</span><br><span class="line">OPERATOR .</span><br><span class="line">IDENTIFIER List</span><br><span class="line">LINE_SEPERATOR </span><br><span class="line"></span><br><span class="line">LINE_SEPERATOR </span><br><span class="line"></span><br><span class="line">KEYWORD fn</span><br><span class="line">IDENTIFIER main</span><br><span class="line">SYMBOL (</span><br><span class="line">IDENTIFIER args</span><br><span class="line">OPERATOR :</span><br><span class="line">IDENTIFIER List&lt;String&gt;</span><br><span class="line">SYMBOL )</span><br><span class="line">SYMBOL &#123;</span><br><span class="line">LINE_SEPERATOR </span><br><span class="line"></span><br><span class="line">KEYWORD println</span><br><span class="line"><span class="deletion">- LITERAL_STRING hello world!</span></span><br><span class="line"><span class="addition">+ IDENTIFIER &quot;hello</span></span><br><span class="line"><span class="addition">+ IDENTIFIER world!&quot;</span></span><br><span class="line">LINE_SEPERATOR </span><br><span class="line"></span><br><span class="line">SYMBOL &#125;</span><br><span class="line">5: RIGHT_BRACKET &#125;</span><br></pre></td></tr></table></figure>

<p>相比你已经注意到了，理应出现的 <code>LITERAL_STRING</code> 被两个 IDENTIFIER 代替了，这显然不是我们想要的结果。因此，我们要给 String 加入特 殊 支 持  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(now)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">                    <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; charStream[i - <span class="number">1</span>] != <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">                        <span class="comment">// string starts or end</span></span><br><span class="line">                        inIdOrLiteral = !inIdOrLiteral;</span><br><span class="line">                        stringMode = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">if</span> (!inIdOrLiteral) &#123;</span><br><span class="line">                            stringMode = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="comment">// a new string!</span></span><br><span class="line">                            nodes.add(<span class="keyword">new</span> LexedNode(buffer.toString(), LexedNode.NodeType.LITERAL_STRING));</span><br><span class="line">                            buffer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及</p>
<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    case &#x27; &#x27;:</span><br><span class="line"><span class="addition">+        if (stringMode) &#123;</span></span><br><span class="line"><span class="addition">+            break;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- if (SYMBOL_OR_OPERATORS.contains(now)) &#123;</span></span><br><span class="line"><span class="addition">+ if (SYMBOL_OR_OPERATORS.contains(now) &amp;&amp; !stringMode) &#123;</span></span><br></pre></td></tr></table></figure>

<p>这样我们就躲开了这个陷阱，完成了对于 String 的支持后，我们的 <code>fuzzyTokenize</code> 就做好了！</p>
<blockquote>
<p>关于 OPERATORS 和 SYMBOLS<br>一门语言里的符号很多，你绝对不会想把他们一个个 add 到 list 里面的，但你可以写一个 <a target="_blank" rel="noopener" href="https://github.com/iceBear67/NullCatLang/blob/85a9b3234bcaab21451c0c6023f46d3599e5764d/src/main/java/io/ib67/lexer/Lexer.java#L11-L34">loader</a> 来解决这个问题  </p>
<p><img src="https://upload.cc/i1/2021/10/01/HwBhRN.png"></p>
</blockquote>
<hr>
<p>然后，是 <code>tokenizer</code>。占个坑位等更新</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>从零开始的编译器生涯</p><p><a href="https://nstd.sfclub.cc/2021/10/01/Writting-A-Compiler-1/">https://nstd.sfclub.cc/2021/10/01/Writting-A-Compiler-1/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>iceBear67</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-10-01</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-10-01</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="../../../../https:/creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="fab fa-creative-commons"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="../../../../tags/tech/">tech</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="../../../07/18/Idea/"><span class="level-item">修复 Intellij IDEA 无法使用中文输入法</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "63cda765d8f3babd3227b1c577d96aa3",
            repo: "blog",
            owner: "iceBear67",
            clientID: "c3c194327dc2507baa72",
            clientSecret: "395d0d173306b934fbfd1d83d8aac9f56aeb3fc0",
            admin: ["iceBear67"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: "last",
            proxy: "https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token",
            
            enableHotKey: true,
            
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="../../../../avatar.png" alt="iceBear 67"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">iceBear 67</p><p class="is-size-6 is-block">I have no slogan...now.</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>UTC +8</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="../../../../archives"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="../../../../categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="../../../../tags"><p class="title">3</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="GitHub" href="../../../../https:/github.com/iceBear67"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Channel" href="../../../../https:/t.me/ice_bear_w"><i class="fab fa-telegram-plane"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="EMail" href="../../../../mailto:/icebear67@sfclub.cc"><i class="fas fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="../../../../atom.xml"><i class="fas fa-rss"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-10-01T14:12:37.000Z">2021-10-01</time></p><p class="title"><a href="">从零开始的编译器生涯</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-18T05:51:17.000Z">2021-07-18</time></p><p class="title"><a href="../../../07/18/Idea/">修复 Intellij IDEA 无法使用中文输入法</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-13T14:57:30.000Z">2021-03-13</time></p><p class="title"><a href="../../../03/13/%E4%BD%BF%E7%94%A8-cproxy-%E5%AF%B9%E7%A8%8B%E5%BA%8F%E8%BF%9B%E8%A1%8C%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86/">使用 cproxy 对程序进行透明代理</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-12T14:43:58.173Z">2021-03-12</time></p><p class="title"><a href="../../../03/12/hello-world/">Hello World</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="../../../../archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="../../../../archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="../../../../archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="../../../../tags/idea-fcitx-ibus/"><span class="tag">idea,fcitx,ibus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../tags/tech/"><span class="tag">tech</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="../../../../tags/tech-linux/"><span class="tag">tech,linux</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="../../../../index.html"><img src="../../../../sitelogo.png" alt="nstd::out" height="28"></a><p class="is-size-7"><span>&copy; 2021 iceBear67</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="../../../../https:/creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="fab fa-creative-commons"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="../../../../js/column.js"></script><script src="../../../../js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="../../../../js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="../../../../js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="../../../../js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"../../../../content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>